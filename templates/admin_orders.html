{% extends "base.html" %}

{% block title %}Управление заказами - Админ панель{% endblock %}

{% block content %}
<!-- Admin Orders Header -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-shopping-cart"></i> Управление заказами</h2>
                <p class="mb-0">Просмотр и управление всеми заказами фотосессий</p>
            </div>
            <a href="{{ url_for('admin') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Назад к панели
            </a>
        </div>
    </div>
</section>

<!-- Orders Management -->
<section class="py-5">
    <div class="container">
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Статус</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Все статусы</option>
                            <option value="pending">Ожидает</option>
                            <option value="confirmed">Подтвержден</option>
                            <option value="completed">Завершен</option>
                            <option value="cancelled">Отменен</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Тип съемки</label>
                        <select class="form-select" id="typeFilter">
                            <option value="">Все типы</option>
                            <option value="Портретная съемка">Портретная съемка</option>
                            <option value="Свадебная фотосъемка">Свадебная фотосъемка</option>
                            <option value="Семейная фотосессия">Семейная фотосессия</option>
                            <option value="Детская фотосессия">Детская фотосессия</option>
                            <option value="Модная фотосъемка">Модная фотосъемка</option>
                            <option value="Пейзажная фотография">Пейзажная фотография</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Дата от</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Дата до</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Применить фильтры
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Сбросить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Заказы ({{ orders|length }})</h5>
                <div>
                    <button class="btn btn-success btn-sm" onclick="createNewOrder()">
                        <i class="fas fa-plus"></i> Новый заказ
                    </button>
                    <button class="btn btn-info btn-sm ms-2" onclick="exportOrders()">
                        <i class="fas fa-download"></i> Экспорт
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if orders %}
                <div class="table-responsive">
                    <table class="table table-hover" id="ordersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Email</th>
                                <th>Телефон</th>
                                <th>Тип съемки</th>
                                <th>Дата</th>
                                <th>Локация</th>
                                <th>Статус</th>
                                <th>Создан</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr data-order-id="{{ order.id }}" data-status="{{ order.status }}" 
                                data-type="{{ order.session_type }}" data-date="{{ order.date.strftime('%Y-%m-%d') }}">
                                <td>#{{ order.id }}</td>
                                <td>{{ order.name }}</td>
                                <td>{{ order.email }}</td>
                                <td>{{ order.phone or 'Не указан' }}</td>
                                <td>{{ order.session_type }}</td>
                                <td>{{ order.date.strftime('%d.%m.%Y') }}</td>
                                <td>{{ order.location or 'Не указана' }}</td>
                                <td>
                                    <select class="form-select form-select-sm status-select" 
                                            onchange="updateOrderStatus({{ order.id }}, this.value)">
                                        <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>
                                            Ожидает
                                        </option>
                                        <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>
                                            Подтвержден
                                        </option>
                                        <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>
                                            Завершен
                                        </option>
                                        <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>
                                            Отменен
                                        </option>
                                    </select>
                                </td>
                                <td>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="viewOrderDetails({{ order.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="editOrder({{ order.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteOrder({{ order.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h5>Заказов пока нет</h5>
                    <p class="text-muted">Создайте первый заказ или дождитесь заявок от клиентов</p>
                    <button class="btn btn-primary" onclick="createNewOrder()">
                        <i class="fas fa-plus"></i> Создать заказ
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали заказа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="editOrderFromModal()">Редактировать</button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Order Modal -->
<div class="modal fade" id="orderEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderEditModalTitle">Создать заказ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="orderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderName" class="form-label">Имя клиента *</label>
                                <input type="text" class="form-control" id="orderName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderEmail" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="orderEmail" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderPhone" class="form-label">Телефон</label>
                                <input type="tel" class="form-control" id="orderPhone" placeholder="+7 (999) 123-45-67">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderSessionType" class="form-label">Тип съемки *</label>
                                <select class="form-select" id="orderSessionType" required>
                                    <option value="">Выберите тип</option>
                                    <option value="Портретная съемка">Портретная съемка</option>
                                    <option value="Свадебная фотосъемка">Свадебная фотосъемка</option>
                                    <option value="Семейная фотосессия">Семейная фотосессия</option>
                                    <option value="Детская фотосессия">Детская фотосессия</option>
                                    <option value="Модная фотосъемка">Модная фотосъемка</option>
                                    <option value="Пейзажная фотография">Пейзажная фотография</option>
                                    <option value="Корпоративная съемка">Корпоративная съемка</option>
                                    <option value="Другое">Другое</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderDate" class="form-label">Дата съемки *</label>
                                <input type="date" class="form-control" id="orderDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderLocation" class="form-label">Место съемки</label>
                                <input type="text" class="form-control" id="orderLocation" placeholder="Студия, парк, дом и т.д.">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="orderMessage" class="form-label">Дополнительная информация</label>
                        <textarea class="form-control" id="orderMessage" rows="3" 
                                  placeholder="Описание пожеланий, особых требований..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderStatus" class="form-label">Статус *</label>
                                <select class="form-select" id="orderStatus" required>
                                    <option value="pending">Ожидает</option>
                                    <option value="confirmed">Подтвержден</option>
                                    <option value="completed">Завершен</option>
                                    <option value="cancelled">Отменен</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="orderPrice" class="form-label">Стоимость (₽)</label>
                                <input type="number" class="form-control" id="orderPrice" min="0" step="100" placeholder="0">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveOrder()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script>
// Filter functions
function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const type = document.getElementById('typeFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    const rows = document.querySelectorAll('#ordersTable tbody tr');
    
    rows.forEach(row => {
        let show = true;
        
        // Status filter
        if (status && row.dataset.status !== status) {
            show = false;
        }
        
        // Type filter
        if (type && row.dataset.type !== type) {
            show = false;
        }
        
        // Date filters
        if (dateFrom && row.dataset.date < dateFrom) {
            show = false;
        }
        
        if (dateTo && row.dataset.date > dateTo) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    
    const rows = document.querySelectorAll('#ordersTable tbody tr');
    rows.forEach(row => row.style.display = '');
}

// Order management functions
function createNewOrder() {
    document.getElementById('orderEditModalTitle').textContent = 'Создать заказ';
    document.getElementById('orderForm').reset();
    document.getElementById('orderForm').removeAttribute('data-edit-id');
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('orderDate').value = today;
    
    const modal = new bootstrap.Modal(document.getElementById('orderEditModal'));
    modal.show();
}

function editOrder(orderId) {
    // Find the order row
    const orderRow = document.querySelector(`[data-order-id="${orderId}"]`);
    if (!orderRow) return;
    
    // Get order data from the row
    const name = orderRow.cells[1].textContent;
    const email = orderRow.cells[2].textContent;
    const phone = orderRow.cells[3].textContent;
    const sessionType = orderRow.cells[4].textContent;
    const date = orderRow.cells[5].textContent.split('.').reverse().join('-');
    const location = orderRow.cells[6].textContent;
    const status = orderRow.dataset.status;
    
    // Populate form
    document.getElementById('orderEditModalTitle').textContent = 'Редактировать заказ';
    document.getElementById('orderName').value = name;
    document.getElementById('orderEmail').value = email;
    document.getElementById('orderPhone').value = phone === 'Не указан' ? '' : phone;
    document.getElementById('orderSessionType').value = sessionType;
    document.getElementById('orderDate').value = date;
    document.getElementById('orderLocation').value = location === 'Не указана' ? '' : location;
    document.getElementById('orderStatus').value = status;
    
    // Store order ID for editing
    document.getElementById('orderForm').dataset.editId = orderId;
    
    const modal = new bootstrap.Modal(document.getElementById('orderEditModal'));
    modal.show();
}

function saveOrder() {
    const form = document.getElementById('orderForm');
    const editId = form.dataset.editId;
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Get form data
    const orderData = {
        name: document.getElementById('orderName').value,
        email: document.getElementById('orderEmail').value,
        phone: document.getElementById('orderPhone').value,
        session_type: document.getElementById('orderSessionType').value,
        date: document.getElementById('orderDate').value,
        location: document.getElementById('orderLocation').value,
        message: document.getElementById('orderMessage').value,
        status: document.getElementById('orderStatus').value,
        price: parseFloat(document.getElementById('orderPrice').value) || 0
    };
    
    if (editId) {
        // Update existing order
        updateOrder(editId, orderData);
    } else {
        // Create new order
        createOrder(orderData);
    }
}

function createOrder(orderData) {
    // This would typically make an AJAX call to the server
    alert('Создание заказа - функция в разработке');
    console.log('New order data:', orderData);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('orderEditModal'));
    modal.hide();
}

function updateOrder(orderId, orderData) {
    // This would typically make an AJAX call to the server
    alert(`Обновление заказа #${orderId} - функция в разработке`);
    console.log('Updated order data:', orderData);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('orderEditModal'));
    modal.hide();
}

function viewOrderDetails(orderId) {
    // Find the order row
    const orderRow = document.querySelector(`[data-order-id="${orderId}"]`);
    if (!orderRow) return;
    
    // Get order data from the row
    const name = orderRow.cells[1].textContent;
    const email = orderRow.cells[2].textContent;
    const phone = orderRow.cells[3].textContent;
    const sessionType = orderRow.cells[4].textContent;
    const date = orderRow.cells[5].textContent;
    const location = orderRow.cells[6].textContent;
    const status = orderRow.dataset.status;
    const created = orderRow.cells[8].textContent;
    
    // Populate modal content
    document.getElementById('orderDetailsContent').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Основная информация</h6>
                <p><strong>ID заказа:</strong> #${orderId}</p>
                <p><strong>Имя клиента:</strong> ${name}</p>
                <p><strong>Email:</strong> ${email}</p>
                <p><strong>Телефон:</strong> ${phone}</p>
                <p><strong>Тип съемки:</strong> ${sessionType}</p>
                <p><strong>Дата съемки:</strong> ${date}</p>
                <p><strong>Место съемки:</strong> ${location}</p>
                <p><strong>Статус:</strong> ${getStatusText(status)}</p>
                <p><strong>Дата создания:</strong> ${created}</p>
            </div>
            <div class="col-md-6">
                <h6>Дополнительная информация</h6>
                <p><strong>Сообщение:</strong></p>
                <p class="text-muted">${getMessageText(orderId)}</p>
                
                <h6 class="mt-3">История изменений</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-clock text-primary me-2"></i>Заказ создан: ${created}</li>
                    <li><i class="fas fa-info-circle text-info me-2"></i>Статус: ${getStatusText(status)}</li>
                </ul>
            </div>
        </div>
    `;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    modal.show();
}

function editOrderFromModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
    modal.hide();
    // Add edit functionality here
}

function updateOrderStatus(orderId, newStatus) {
    // This would typically make an AJAX call to the server
    console.log(`Updating order #${orderId} status to: ${newStatus}`);
    
    // Update the row data attribute
    const orderRow = document.querySelector(`[data-order-id="${orderId}"]`);
    if (orderRow) {
        orderRow.dataset.status = newStatus;
    }
    
    // Show success message
    showStatusUpdateMessage(orderId, newStatus);
}

function showStatusUpdateMessage(orderId, status) {
    // Create a temporary success message
    const message = document.createElement('div');
    message.className = 'alert alert-success alert-dismissible fade show position-fixed';
    message.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    message.innerHTML = `
        Статус заказа #${orderId} обновлен на "${getStatusText(status)}"
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(message);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (message.parentNode) {
            message.remove();
        }
    }, 3000);
}

function deleteOrder(orderId) {
    if (confirm(`Вы уверены, что хотите удалить заказ #${orderId}?`)) {
        // This would typically make an AJAX call to the server
        alert(`Удаление заказа #${orderId} - функция в разработке`);
    }
}

function exportOrders() {
    // Export orders to CSV or Excel
    alert('Экспорт заказов - функция в разработке');
}

// Helper functions
function getStatusText(status) {
    const statusMap = {
        'pending': 'Ожидает',
        'confirmed': 'Подтвержден',
        'completed': 'Завершен',
        'cancelled': 'Отменен'
    };
    return statusMap[status] || status;
}

function getMessageText(orderId) {
    // This would typically fetch the actual message from the server
    return 'Сообщение клиента будет загружено с сервера...';
}
</script>
{% endblock %}
